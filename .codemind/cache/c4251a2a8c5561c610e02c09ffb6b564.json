{
  "content": "#!/usr/bin/env node\r\n\r\n/**\r\n * Complete Database Initialization Script for CodeMind\r\n * Initializes: PostgreSQL, MongoDB, Neo4j, Redis, DuckDB\r\n * Creates all necessary tables, collections, indexes, and foundation data\r\n */\r\n\r\nconst { Pool } = require('pg');\r\nconst { MongoClient } = require('mongodb');\r\nconst neo4j = require('neo4j-driver');\r\nconst Redis = require('ioredis');\r\nconst fs = require('fs').promises;\r\nconst path = require('path');\r\nconst chalk = require('chalk');\r\n\r\n// Configuration\r\nconst config = {\r\n  postgres: {\r\n    host: process.env.DB_HOST || 'localhost',\r\n    port: process.env.DB_PORT || 5432,\r\n    database: process.env.DB_NAME || 'codemind',\r\n    user: process.env.DB_USER || 'codemind',\r\n    password: process.env.DB_PASSWORD || 'codemind123'\r\n  },\r\n  mongodb: {\r\n    uri: process.env.MONGO_URI || \r\n      `mongodb://${process.env.MONGO_USER || 'codemind'}:${process.env.MONGO_PASSWORD || 'codemind123'}@${process.env.MONGO_HOST || 'localhost'}:${process.env.MONGO_PORT || 27017}/${process.env.MONGO_DB || 'codemind'}?authSource=admin`\r\n  },\r\n  neo4j: {\r\n    uri: process.env.NEO4J_URI || 'bolt://localhost:7687',\r\n    user: process.env.NEO4J_USER || 'neo4j',\r\n    password: process.env.NEO4J_PASSWORD || 'codemind123'\r\n  },\r\n  redis: {\r\n    host: process.env.REDIS_HOST || 'localhost',\r\n    port: process.env.REDIS_PORT || 6379,\r\n    password: process.env.REDIS_PASSWORD || undefined\r\n  }\r\n};\r\n\r\n// Initialize PostgreSQL\r\nasync function initializePostgreSQL() {\r\n  console.log(chalk.blue('ðŸ“˜ Initializing PostgreSQL...'));\r\n  const pgClient = new Pool(config.postgres);\r\n  \r\n  try {\r\n    // Read and execute schema file\r\n    const schemaPath = path.join(__dirname, '..', 'src', 'database', 'schema.postgres.sql');\r\n    const schema = await fs.readFile(schemaPath, 'utf-8');\r\n    \r\n    // Split by statements and execute\r\n    const statements = schema.split(';').filter(s => s.trim());\r\n    for (const statement of statements) {\r\n      if (statement.trim()) {\r\n        await pgClient.query(statement);\r\n      }\r\n    }\r\n    \r\n    console.log(chalk.green('âœ… PostgreSQL initialized successfully'));\r\n    \r\n    // Insert foundation data\r\n    await pgClient.query(`\r\n      INSERT INTO projects (id, project_name, project_path, status, languages, frameworks, project_type, created_at)\r\n      VALUES \r\n        ('00000000-0000-0000-0000-000000000000', 'Default', '/default', 'active', '{}', '{}', 'template', NOW())\r\n      ON CONFLICT (id) DO NOTHING;\r\n    `);\r\n    \r\n    console.log(chalk.green('âœ… PostgreSQL foundation data inserted'));\r\n    \r\n  } catch (error) {\r\n    console.error(chalk.red('âŒ PostgreSQL initialization failed:'), error.message);\r\n    throw error;\r\n  } finally {\r\n    await pgClient.end();\r\n  }\r\n}\r\n\r\n// Initialize MongoDB\r\nasync function initializeMongoDB() {\r\n  console.log(chalk.blue('ðŸ“„ Initializing MongoDB...'));\r\n  const client = new MongoClient(config.mongodb.uri);\r\n  \r\n  try {\r\n    await client.connect();\r\n    const db = client.db('codemind');\r\n    \r\n    // Create collections\r\n    const collections = [\r\n      'tool_configs',\r\n      'analysis_results',\r\n      'project_intelligence',\r\n      'knowledge_repository',\r\n      'workflow_states',\r\n      'templates'\r\n    ];\r\n    \r\n    for (const collectionName of collections) {\r\n      try {\r\n        await db.createCollection(collectionName);\r\n        console.log(chalk.gray(`  Created collection: ${collectionName}`));\r\n      } catch (err) {\r\n        if (err.code !== 48) { // Collection already exists\r\n          throw err;\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Create indexes\r\n    await db.collection('tool_configs').createIndex({ projectId: 1, toolName: 1 }, { unique: true });\r\n    await db.collection('analysis_results').createIndex({ projectId: 1, toolName: 1, timestamp: -1 });\r\n    await db.collection('analysis_results').createIndex({ summary: 'text' });\r\n    await db.collection('project_intelligence').createIndex({ projectId: 1 }, { unique: true });\r\n    await db.collection('knowledge_repository').createIndex({ \r\n      title: 'text', \r\n      content: 'text', \r\n      searchableText: 'text' \r\n    });\r\n    \r\n    console.log(chalk.green('âœ… MongoDB collections and indexes created'));\r\n    \r\n    // Insert foundation data\r\n    const toolConfigs = db.collection('tool_configs');\r\n    await toolConfigs.insertMany([\r\n      {\r\n        projectId: 'default',\r\n        toolName: 'semantic-search',\r\n        config: {\r\n          embeddingModel: 'text-embedding-ada-002',\r\n          chunkSize: 4000,\r\n          overlapSize: 200,\r\n          similarity: 'cosine',\r\n          cacheEnabled: true\r\n        },\r\n        version: '1.0.0',\r\n        updatedAt: new Date()\r\n      },\r\n      {\r\n        projectId: 'default',\r\n        toolName: 'solid-principles',\r\n        config: {\r\n          checkSRP: true,\r\n          checkOCP: true,\r\n          checkLSP: true,\r\n          checkISP: true,\r\n          checkDIP: true,\r\n          severityThreshold: 'medium'\r\n        },\r\n        version: '1.0.0',\r\n        updatedAt: new Date()\r\n      }\r\n    ]).catch(err => {\r\n      if (err.code !== 11000) throw err; // Ignore duplicate key errors\r\n    });\r\n    \r\n    console.log(chalk.green('âœ… MongoDB foundation data inserted'));\r\n    \r\n  } catch (error) {\r\n    console.error(chalk.red('âŒ MongoDB initialization failed:'), error.message);\r\n    throw error;\r\n  } finally {\r\n    await client.close();\r\n  }\r\n}\r\n\r\n// Initialize Neo4j\r\nasync function initializeNeo4j() {\r\n  console.log(chalk.blue('ðŸ”— Initializing Neo4j...'));\r\n  const driver = neo4j.driver(\r\n    config.neo4j.uri,\r\n    neo4j.auth.basic(config.neo4j.user, config.neo4j.password)\r\n  );\r\n  \r\n  try {\r\n    const session = driver.session();\r\n    \r\n    // Create constraints and indexes\r\n    const queries = [\r\n      'CREATE CONSTRAINT project_id IF NOT EXISTS FOR (p:Project) REQUIRE p.id IS UNIQUE',\r\n      'CREATE CONSTRAINT file_path IF NOT EXISTS FOR (f:File) REQUIRE (f.projectId, f.path) IS UNIQUE',\r\n      'CREATE CONSTRAINT class_name IF NOT EXISTS FOR (c:Class) REQUIRE (c.projectId, c.name) IS UNIQUE',\r\n      'CREATE CONSTRAINT function_name IF NOT EXISTS FOR (fn:Function) REQUIRE (fn.projectId, fn.name, fn.file) IS UNIQUE',\r\n      'CREATE INDEX project_name IF NOT EXISTS FOR (p:Project) ON (p.name)',\r\n      'CREATE INDEX file_type IF NOT EXISTS FOR (f:File) ON (f.type)',\r\n      'CREATE INDEX class_type IF NOT EXISTS FOR (c:Class) ON (c.type)',\r\n      'CREATE INDEX function_exported IF NOT EXISTS FOR (fn:Function) ON (fn.exported)'\r\n    ];\r\n    \r\n    for (const query of queries) {\r\n      try {\r\n        await session.run(query);\r\n        console.log(chalk.gray(`  Executed: ${query.substring(0, 50)}...`));\r\n      } catch (err) {\r\n        if (!err.message.includes('already exists')) {\r\n          throw err;\r\n        }\r\n      }\r\n    }\r\n    \r\n    console.log(chalk.green('âœ… Neo4j constraints and indexes created'));\r\n    \r\n    // Create foundation nodes\r\n    await session.run(`\r\n      MERGE (p:Project {id: 'default'})\r\n      SET p.name = 'Default Project',\r\n          p.createdAt = datetime(),\r\n          p.status = 'template'\r\n    `);\r\n    \r\n    console.log(chalk.green('âœ… Neo4j foundation data inserted'));\r\n    \r\n    await session.close();\r\n  } catch (error) {\r\n    console.error(chalk.red('âŒ Neo4j initialization failed:'), error.message);\r\n    throw error;\r\n  } finally {\r\n    await driver.close();\r\n  }\r\n}\r\n\r\n// Initialize Redis\r\nasync function initializeRedis() {\r\n  console.log(chalk.blue('âš¡ Initializing Redis...'));\r\n  const redis = new Redis(config.redis);\r\n  \r\n  try {\r\n    // Set up key patterns and initial values\r\n    await redis.set('codemind:initialized', new Date().toISOString());\r\n    await redis.hset('codemind:config', {\r\n      version: '2.0.0',\r\n      initialized_at: new Date().toISOString()\r\n    });\r\n    \r\n    // Create initial queues\r\n    await redis.lpush('codemind:queue:analysis', JSON.stringify({\r\n      type: 'init',\r\n      timestamp: new Date().toISOString()\r\n    }));\r\n    await redis.ltrim('codemind:queue:analysis', 0, 0); // Keep only the init message\r\n    \r\n    // Set up pub/sub channels\r\n    await redis.publish('codemind:events', JSON.stringify({\r\n      event: 'system_initialized',\r\n      timestamp: new Date().toISOString()\r\n    }));\r\n    \r\n    console.log(chalk.green('âœ… Redis initialized with queues and channels'));\r\n    \r\n  } catch (error) {\r\n    console.error(chalk.red('âŒ Redis initialization failed:'), error.message);\r\n    throw error;\r\n  } finally {\r\n    redis.disconnect();\r\n  }\r\n}\r\n\r\n// Initialize DuckDB (create directory structure)\r\nasync function initializeDuckDB() {\r\n  console.log(chalk.blue('ðŸ“Š Initializing DuckDB directories...'));\r\n  \r\n  try {\r\n    // Create .codemind directory for analytics databases\r\n    const dirs = [\r\n      path.join(process.cwd(), '.codemind'),\r\n      path.join(process.cwd(), '.codemind', 'analytics'),\r\n      path.join(process.cwd(), '.codemind', 'cache')\r\n    ];\r\n    \r\n    for (const dir of dirs) {\r\n      await fs.mkdir(dir, { recursive: true });\r\n      console.log(chalk.gray(`  Created directory: ${dir}`));\r\n    }\r\n    \r\n    console.log(chalk.green('âœ… DuckDB directories created'));\r\n    \r\n  } catch (error) {\r\n    console.error(chalk.red('âŒ DuckDB initialization failed:'), error.message);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// Test connections\r\nasync function testConnections() {\r\n  console.log(chalk.blue('\\nðŸ” Testing database connections...'));\r\n  \r\n  const results = {\r\n    postgres: false,\r\n    mongodb: false,\r\n    neo4j: false,\r\n    redis: false\r\n  };\r\n  \r\n  // Test PostgreSQL\r\n  try {\r\n    const pgClient = new Pool(config.postgres);\r\n    await pgClient.query('SELECT 1');\r\n    await pgClient.end();\r\n    results.postgres = true;\r\n    console.log(chalk.green('âœ… PostgreSQL connection successful'));\r\n  } catch (err) {\r\n    console.log(chalk.yellow('âš ï¸  PostgreSQL connection failed'));\r\n  }\r\n  \r\n  // Test MongoDB\r\n  try {\r\n    const client = new MongoClient(config.mongodb.uri);\r\n    await client.connect();\r\n    await client.db().admin().ping();\r\n    await client.close();\r\n    results.mongodb = true;\r\n    console.log(chalk.green('âœ… MongoDB connection successful'));\r\n  } catch (err) {\r\n    console.log(chalk.yellow('âš ï¸  MongoDB connection failed'));\r\n  }\r\n  \r\n  // Test Neo4j\r\n  try {\r\n    const driver = neo4j.driver(\r\n      config.neo4j.uri,\r\n      neo4j.auth.basic(config.neo4j.user, config.neo4j.password)\r\n    );\r\n    const session = driver.session();\r\n    await session.run('RETURN 1');\r\n    await session.close();\r\n    await driver.close();\r\n    results.neo4j = true;\r\n    console.log(chalk.green('âœ… Neo4j connection successful'));\r\n  } catch (err) {\r\n    console.log(chalk.yellow('âš ï¸  Neo4j connection failed'));\r\n  }\r\n  \r\n  // Test Redis\r\n  try {\r\n    const redis = new Redis(config.redis);\r\n    await redis.ping();\r\n    redis.disconnect();\r\n    results.redis = true;\r\n    console.log(chalk.green('âœ… Redis connection successful'));\r\n  } catch (err) {\r\n    console.log(chalk.yellow('âš ï¸  Redis connection failed'));\r\n  }\r\n  \r\n  return results;\r\n}\r\n\r\n// Main execution\r\nasync function main() {\r\n  console.log(chalk.bold.cyan('\\nðŸš€ CodeMind Database Initialization\\n'));\r\n  \r\n  // Test connections first\r\n  const connections = await testConnections();\r\n  \r\n  console.log(chalk.blue('\\nðŸ“¦ Starting initialization...\\n'));\r\n  \r\n  // Initialize databases that are available\r\n  const tasks = [];\r\n  \r\n  if (connections.postgres) {\r\n    tasks.push(initializePostgreSQL());\r\n  } else {\r\n    console.log(chalk.yellow('â­ï¸  Skipping PostgreSQL (not connected)'));\r\n  }\r\n  \r\n  if (connections.mongodb) {\r\n    tasks.push(initializeMongoDB());\r\n  } else {\r\n    console.log(chalk.yellow('â­ï¸  Skipping MongoDB (not connected)'));\r\n  }\r\n  \r\n  if (connections.neo4j) {\r\n    tasks.push(initializeNeo4j());\r\n  } else {\r\n    console.log(chalk.yellow('â­ï¸  Skipping Neo4j (not connected)'));\r\n  }\r\n  \r\n  if (connections.redis) {\r\n    tasks.push(initializeRedis());\r\n  } else {\r\n    console.log(chalk.yellow('â­ï¸  Skipping Redis (not connected)'));\r\n  }\r\n  \r\n  // Always initialize DuckDB directories\r\n  tasks.push(initializeDuckDB());\r\n  \r\n  // Execute all initialization tasks\r\n  try {\r\n    await Promise.all(tasks);\r\n    \r\n    console.log(chalk.bold.green('\\nâœ¨ All databases initialized successfully!\\n'));\r\n    console.log(chalk.gray('You can now run: npm run dashboard or docker-compose up'));\r\n    \r\n  } catch (error) {\r\n    console.error(chalk.bold.red('\\nâŒ Initialization failed!\\n'));\r\n    console.error(error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// Run if called directly\r\nif (require.main === module) {\r\n  main().catch(error => {\r\n    console.error(chalk.red('Fatal error:'), error);\r\n    process.exit(1);\r\n  });\r\n}\r\n\r\nmodule.exports = { main, testConnections };",
  "hash": "050371a2efb794ae0eb6df2e3a707df28e0146145b0800dcfd581850df315101",
  "lastModified": 1758036122385,
  "language": "JavaScript",
  "exports": [],
  "imports": [],
  "functions": [
    "const",
    "const",
    "const",
    "const",
    "const",
    "const",
    "function",
    "const",
    "const",
    "const",
    "const",
    "function",
    "const",
    "const",
    "const",
    "const",
    "function",
    "const",
    "const",
    "const",
    "function",
    "const",
    "function",
    "const",
    "function",
    "const",
    "const",
    "const",
    "const",
    "const",
    "const",
    "function",
    "const",
    "const"
  ],
  "classes": []
}