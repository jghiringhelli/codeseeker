{
  "content": "#!/usr/bin/env node\n\n/**\n * CodeMind Complete Setup Script\n * \n * Single entry point for:\n * - Docker container management (PostgreSQL, Redis, Neo4j)\n * - Database initialization (all types)\n * - Health checks and verification\n * \n * Usage: npm run setup\n */\n\nconst { execSync } = require('child_process');\nconst fs = require('fs').promises;\nconst path = require('path');\nconst chalk = require('chalk');\n\n// Import existing database initialization functions\nconst { testConnections, initializePostgreSQL, initializeNeo4j, initializeRedis } = require('./helpers/database-init');\n\nclass CodeMindSetup {\n  constructor() {\n    this.startTime = Date.now();\n    this.status = {\n      docker: false,\n      databases: {\n        postgres: false,\n        neo4j: false, \n        redis: false\n      },\n      initialization: false\n    };\n  }\n\n  async run() {\n    console.log(chalk.blue.bold('üöÄ CodeMind Complete Setup'));\n    console.log(chalk.gray('Setting up Docker containers, databases, and initialization...\\n'));\n\n    try {\n      await this.checkPrerequisites();\n      await this.setupDockerContainers();\n      await this.initializeDatabases();\n      await this.verifySetup();\n      await this.displaySummary();\n\n      console.log(chalk.green.bold('\\n‚úÖ Setup completed successfully!'));\n      console.log(chalk.cyan('Next steps:'));\n      console.log(chalk.cyan('  1. cd <your-project-directory>'));\n      console.log(chalk.cyan('  2. codemind (or npm run codemind)'));\n      console.log(chalk.cyan('  3. Type /init to populate project data'));\n      \n    } catch (error) {\n      console.error(chalk.red.bold('\\n‚ùå Setup failed:'), error.message);\n      console.error(chalk.gray('Check the logs above for details.'));\n      process.exit(1);\n    }\n  }\n\n  async checkPrerequisites() {\n    console.log(chalk.yellow('üîç Checking prerequisites...'));\n    \n    try {\n      execSync('docker --version', { stdio: 'pipe' });\n      execSync('docker-compose --version', { stdio: 'pipe' });\n      console.log(chalk.green('  ‚úì Docker and Docker Compose available'));\n    } catch (error) {\n      throw new Error('Docker or Docker Compose not found. Please install Docker Desktop.');\n    }\n\n    // Check if we're in the CodeMind directory\n    const packageJson = path.join(process.cwd(), 'package.json');\n    try {\n      const pkg = JSON.parse(await fs.readFile(packageJson, 'utf-8'));\n      if (pkg.name !== 'codemind-enhanced-cli') {\n        throw new Error('Please run this command from the CodeMind project directory');\n      }\n      console.log(chalk.green('  ‚úì Running from correct directory'));\n    } catch (error) {\n      throw new Error('Not in CodeMind directory or package.json missing');\n    }\n  }\n\n  async setupDockerContainers() {\n    console.log(chalk.yellow('\\nüê≥ Setting up Docker containers...'));\n    \n    try {\n      // Stop any existing containers to avoid conflicts\n      console.log(chalk.gray('  Stopping any existing containers...'));\n      try {\n        execSync('docker-compose down', { stdio: 'pipe' });\n      } catch (error) {\n        // It's ok if there were no containers running\n      }\n\n      // Build and start containers\n      console.log(chalk.gray('  Building and starting containers...'));\n      execSync('docker-compose up -d --build', { \n        stdio: 'inherit',\n        cwd: process.cwd()\n      });\n\n      // Wait for containers to be ready\n      console.log(chalk.gray('  Waiting for containers to be healthy...'));\n      await this.waitForContainerHealth();\n\n      this.status.docker = true;\n      console.log(chalk.green('  ‚úì Docker containers are running and healthy'));\n      \n    } catch (error) {\n      throw new Error(`Docker setup failed: ${error.message}`);\n    }\n  }\n\n  async waitForContainerHealth() {\n    const maxRetries = 30; // 30 seconds max\n    let retries = 0;\n\n    while (retries < maxRetries) {\n      try {\n        const result = execSync('docker-compose ps --format json', { \n          stdio: 'pipe',\n          encoding: 'utf-8'\n        });\n        \n        const containers = JSON.parse(`[${result.trim().split('\\n').join(',')}]`);\n        const allHealthy = containers.every(container => \n          container.State === 'running' && \n          (!container.Health || container.Health === 'healthy')\n        );\n\n        if (allHealthy) {\n          return;\n        }\n        \n      } catch (error) {\n        // Continue retrying\n      }\n\n      await new Promise(resolve => setTimeout(resolve, 1000));\n      retries++;\n      \n      if (retries % 5 === 0) {\n        console.log(chalk.gray(`    Still waiting... (${retries}/${maxRetries}s)`));\n      }\n    }\n\n    throw new Error('Containers did not become healthy within 30 seconds');\n  }\n\n  async initializeDatabases() {\n    console.log(chalk.yellow('\\nüóÑÔ∏è  Initializing databases...'));\n\n    // Test connections first\n    console.log(chalk.gray('  Testing database connections...'));\n    const connections = await testConnections();\n    \n    if (!connections.postgres) {\n      throw new Error('PostgreSQL connection failed');\n    }\n    if (!connections.redis) {\n      throw new Error('Redis connection failed');\n    }\n    if (!connections.neo4j) {\n      throw new Error('Neo4j connection failed');\n    }\n\n    console.log(chalk.green('  ‚úì All database connections successful'));\n\n    // Initialize each database\n    try {\n      console.log(chalk.gray('  Initializing PostgreSQL...'));\n      await initializePostgreSQL();\n      this.status.databases.postgres = true;\n      console.log(chalk.green('    ‚úì PostgreSQL initialized'));\n\n      console.log(chalk.gray('  Initializing Neo4j...'));\n      await initializeNeo4j();\n      this.status.databases.neo4j = true;\n      console.log(chalk.green('    ‚úì Neo4j initialized'));\n\n      console.log(chalk.gray('  Initializing Redis...'));\n      await initializeRedis();\n      this.status.databases.redis = true;\n      console.log(chalk.green('    ‚úì Redis initialized'));\n\n      this.status.initialization = true;\n\n    } catch (error) {\n      throw new Error(`Database initialization failed: ${error.message}`);\n    }\n  }\n\n  async verifySetup() {\n    console.log(chalk.yellow('\\nüîç Verifying setup...'));\n\n    // Test final connections\n    const connections = await testConnections();\n    const allConnected = connections.postgres && connections.redis && connections.neo4j;\n    \n    if (!allConnected) {\n      throw new Error('Some databases are not properly connected after initialization');\n    }\n\n    // Check that CLI is built\n    const cliPath = path.join(process.cwd(), 'dist', 'cli', 'CodeMindCLI.js');\n    try {\n      await fs.access(cliPath);\n      console.log(chalk.green('  ‚úì CLI is built and ready'));\n    } catch (error) {\n      console.log(chalk.yellow('  ‚ö† CLI not built, building now...'));\n      execSync('npm run build', { stdio: 'inherit' });\n      console.log(chalk.green('  ‚úì CLI built successfully'));\n    }\n\n    console.log(chalk.green('  ‚úì Setup verification completed'));\n  }\n\n  async displaySummary() {\n    const duration = Math.round((Date.now() - this.startTime) / 1000);\n    \n    console.log(chalk.blue('\\nüìã Setup Summary:'));\n    console.log(chalk.green(`  ‚úì Docker containers: Running`));\n    console.log(chalk.green(`  ‚úì PostgreSQL: Initialized with schema and indexes`));\n    console.log(chalk.green(`  ‚úì Neo4j: Initialized with constraints and indexes`));\n    console.log(chalk.green(`  ‚úì Redis: Initialized with configuration`));\n    console.log(chalk.green(`  ‚úì CLI: Built and ready`));\n    console.log(chalk.gray(`  ‚è± Total time: ${duration}s`));\n\n    // Display container status\n    try {\n      const containers = execSync('docker-compose ps', { \n        stdio: 'pipe',\n        encoding: 'utf-8'\n      });\n      console.log(chalk.blue('\\nüê≥ Container Status:'));\n      console.log(chalk.gray(containers));\n    } catch (error) {\n      // Non-critical\n    }\n  }\n}\n\n// Run if called directly\nif (require.main === module) {\n  const setup = new CodeMindSetup();\n  setup.run().catch(error => {\n    console.error(chalk.red.bold('Setup failed:'), error.message);\n    process.exit(1);\n  });\n}\n\nmodule.exports = { CodeMindSetup };",
  "hash": "2ebe82f8a97ff933ae9b565fbc6e9d74f32d871d8b7dd9d2fb004284b8433912",
  "lastModified": 1757955477769,
  "language": "JavaScript",
  "exports": [],
  "imports": [],
  "functions": [
    "const",
    "const",
    "const",
    "const",
    "const",
    "const",
    "let",
    "const",
    "const",
    "const",
    "const",
    "const",
    "const",
    "const",
    "const",
    "const",
    "const"
  ],
  "classes": [
    "CodeMindSetup"
  ]
}