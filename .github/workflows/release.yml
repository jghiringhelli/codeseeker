name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.8.0)'
        required: true
        type: string
      skip_homebrew:
        description: 'Skip Homebrew publish'
        type: boolean
        default: false
      skip_chocolatey:
        description: 'Skip Chocolatey publish'
        type: boolean
        default: false
      skip_snap:
        description: 'Skip Snap publish'
        type: boolean
        default: false
      skip_mcp:
        description: 'Skip MCP Registry publish'
        type: boolean
        default: false

# Note: npm publishing is done manually due to 2FA requirements
# Run: npm login && npm publish --access public

env:
  # Use input version for workflow_dispatch, or extract from tag for push
  VERSION: ${{ inputs.version || github.ref_name }}

jobs:
  publish-homebrew:
    if: ${{ !inputs.skip_homebrew }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Update Homebrew formula
        env:
          HOMEBREW_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          RELEASE_VERSION: ${{ env.VERSION }}
        run: |
          VERSION=${RELEASE_VERSION#v}
          SHA256=$(curl -sL "https://registry.npmjs.org/codeseeker/-/codeseeker-${VERSION}.tgz" | sha256sum | cut -d' ' -f1)

          git clone https://x-access-token:${HOMEBREW_GITHUB_TOKEN}@github.com/jghiringhelli/homebrew-codeseeker.git
          cd homebrew-codeseeker

          cat > Formula/codeseeker.rb << EOF
          class Codeseeker < Formula
            desc "Graph-powered code intelligence for Claude Code"
            homepage "https://github.com/jghiringhelli/codeseeker"
            url "https://registry.npmjs.org/codeseeker/-/codeseeker-${VERSION}.tgz"
            sha256 "${SHA256}"
            license "MIT"
            depends_on "node@18"

            def install
              system "npm", "install", *std_npm_args
              bin.install_symlink Dir["\#{libexec}/bin/*"]
            end

            test do
              system "\#{bin}/codeseeker", "--version"
            end
          end
          EOF

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/codeseeker.rb
          git commit -m "Update codeseeker to ${VERSION}"
          git push

  publish-chocolatey:
    if: ${{ !inputs.skip_chocolatey }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Update and push Chocolatey package
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        shell: pwsh
        run: |
          $version = "${{ env.VERSION }}".TrimStart('v')

          # Update nuspec version
          $nuspec = Get-Content chocolatey/codeseeker.nuspec
          $nuspec = $nuspec -replace '<version>.*</version>', "<version>$version</version>"
          $nuspec | Set-Content chocolatey/codeseeker.nuspec

          # Update install script version
          $install = Get-Content chocolatey/tools/chocolateyinstall.ps1
          $install = $install -replace "codeseeker@[\d.]+", "codeseeker@$version"
          $install | Set-Content chocolatey/tools/chocolateyinstall.ps1

          # Pack and push
          cd chocolatey
          choco pack
          choco push codeseeker.$version.nupkg --source https://push.chocolatey.org/ --api-key $env:CHOCO_API_KEY

  publish-snap:
    if: ${{ !inputs.skip_snap }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Update snapcraft.yaml version
        env:
          RELEASE_VERSION: ${{ env.VERSION }}
        run: |
          VERSION=${RELEASE_VERSION#v}
          # Only update the package version line (line 3), not npm-node-version
          sed -i "s/^version: .*/version: '${VERSION}'/" snap/snapcraft.yaml
          # Update the npm tarball URL
          sed -i "s|codeseeker-[0-9.]*\.tgz|codeseeker-${VERSION}.tgz|" snap/snapcraft.yaml
      - uses: snapcore/action-build@v1
        id: build
      - uses: snapcore/action-publish@v1
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
        with:
          snap: ${{ steps.build.outputs.snap }}
          release: stable

  publish-mcp-registry:
    if: ${{ !inputs.skip_mcp }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC authentication
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Update server.json version
        env:
          RELEASE_VERSION: ${{ env.VERSION }}
        run: |
          VERSION=${RELEASE_VERSION#v}
          # Update both version fields in server.json
          jq --arg v "$VERSION" '.version = $v | .packages[0].version = $v' server.json > server.tmp && mv server.tmp server.json
      - name: Install mcp-publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_linux_amd64.tar.gz" | tar xz mcp-publisher
      - name: Authenticate to MCP Registry
        run: ./mcp-publisher login github-oidc
      - name: Publish server to MCP Registry
        run: ./mcp-publisher publish

  create-release:
    needs: [publish-homebrew, publish-chocolatey, publish-snap, publish-mcp-registry]
    # Only create release on tag push, not workflow_dispatch (release already exists)
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## Installation

            ```bash
            # npm (recommended)
            npm install -g codeseeker

            # Homebrew
            brew install jghiringhelli/codeseeker/codeseeker

            # Chocolatey
            choco install codeseeker

            # Snap
            sudo snap install codeseeker
            ```
