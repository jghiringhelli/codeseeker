# Simplified Docker Compose for local development and testing
version: '3.8'

services:
  # Main CodeMind API service for local development
  codemind:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: codemind-local
    ports:
      - "${API_PORT:-3001}:3000"
    environment:
      NODE_ENV: development
      DB_PATH: ":memory:"
      PORT: 3000
      LOG_LEVEL: info
      ENABLE_CACHING: true
      MAX_BATCH_SIZE: 50
    volumes:
      # Persistent data for development
      - codemind-local-data:/app/data
      # Mount workspace for analysis (user can override)
      - ${WORKSPACE_PATH:-../workspace}:/workspace:ro
    networks:
      - codemind-local
    restart: unless-stopped
    command: ["node", "dist/src/api/server.js", "--dev"]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

networks:
  codemind-local:
    driver: bridge
    name: codemind-local

volumes:
  codemind-local-data:
    name: codemind-local-data
    driver: local