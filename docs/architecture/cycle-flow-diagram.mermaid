%% CodeMind Enhanced Cycle Flow Diagram
%% This diagram shows the complete request processing pipeline

graph TD
    A[ğŸ‘¤ User Request<br/>npm run codemind:cycle code 'add auth'] --> B{ğŸ” Request Classification}
    
    B -->|code modification| C[ğŸ“ Code Request]
    B -->|analysis| D[ğŸ“Š Analysis Request] 
    B -->|general| E[ğŸ’¬ General Request]
    
    C --> F[ğŸ—ï¸ Context Building]
    D --> F
    E --> F
    
    F --> G[ğŸ“‚ Git Status Check<br/>git status --porcelain]
    F --> H[ğŸ”§ Technology Detection<br/>package.json, tsconfig.json]
    F --> I[ğŸ¯ Intent Analysis<br/>userIntent: string]
    
    G --> J[ğŸ“‹ ProjectContext Assembly]
    H --> J  
    I --> J
    
    J --> K{ğŸš« Skip Cycles?}
    K -->|No| L[ğŸ”„ Core Safety Cycle]
    K -->|Yes| AA[âš¡ Direct Execution]
    
    %% Core Safety Cycle
    L --> M[ğŸ”¨ Compilation Check<br/>~25-30 seconds]
    M --> N[ğŸ§ª Test Execution<br/>~2-3 seconds]
    N --> O[ğŸ›¡ï¸ Safety Guard<br/>~100ms]
    
    M -->|Fails| P[âŒ Compilation Error]
    N -->|Fails| Q[âš ï¸ Test Warning]
    O -->|Dangerous| R[ğŸš¨ Safety Block]
    
    P --> S{ğŸ”§ Force Flag?}
    R --> S
    S -->|No| T[ğŸ›‘ EXECUTION BLOCKED<br/>Return Error Response]
    S -->|Yes| U[âš ï¸ Continue with Warning]
    
    Q --> U
    M -->|Passes| U
    N -->|Passes| U
    O -->|Safe| U
    
    %% Quality Cycle Branch
    U --> V{ğŸ“ Code Modification?}
    V -->|Yes| W[ğŸ¯ Quality Cycle]
    V -->|No| AA
    
    %% Quality Cycle Details
    W --> X[ğŸ—ï¸ SOLID Analysis<br/>~100ms]
    W --> Y[ğŸ“ Linting Check<br/>~50ms] 
    W --> Z[ğŸ”„ Dependency Cycles<br/>~100ms]
    W --> AB[ğŸ§  Semantic Deduplication<br/>~200ms]
    W --> AC[ğŸ”’ Smart Security<br/>~150ms]
    
    %% Semantic Deduplication Details
    AB --> AD[ğŸ¯ Intent Analysis<br/>Extract functionality]
    AD --> AE{ğŸ§  Neo4j Available?}
    AE -->|Yes| AF[ğŸ” Semantic Search<br/>Query graph for similar code]
    AE -->|No| AG[ğŸ“ Pattern Matching<br/>Regex fallback]
    
    AF --> AH[ğŸ“Š Similarity Scoring<br/>0-1 similarity score]
    AG --> AH
    AH --> AI{ğŸ“ˆ High Similarity?}
    AI -->|>80%| AJ[ğŸš¨ Duplication Warning]
    AI -->|60-80%| AK[âš ï¸ Similar Code Found]
    AI -->|<60%| AL[âœ… Proceed]
    
    %% Smart Security Details  
    AC --> AM[ğŸ¯ Context Detection<br/>Auth, API, File, DB patterns]
    AM --> AN[ğŸ” Pattern Selection<br/>Choose relevant security checks]
    AN --> AO[ğŸ›¡ï¸ Vulnerability Scan<br/>Check changed files]
    AO --> AP[ğŸ“Š Risk Assessment<br/>Calculate overall risk]
    
    %% Quality Results
    X --> AQ[ğŸ“‹ Quality Results]
    Y --> AQ
    Z --> AQ
    AJ --> AQ
    AK --> AQ  
    AL --> AQ
    AP --> AQ
    
    Z -->|Circular Deps| AR[ğŸš« Dependency Block]
    AR --> T
    
    %% Execution Phase
    AA --> AS[ğŸ­ Intelligent Execution]
    AQ --> AS
    
    AS --> AT{ğŸ“ Request Type?}
    AT -->|Code Mod| AU[ğŸ§  Semantic Context Generation]
    AT -->|Analysis| AV[ğŸ“Š Context Optimization]
    AT -->|General| AW[ğŸ’¡ Enhanced Context]
    
    AU --> AX[ğŸ¯ Architecture-Aware Response]
    AV --> AX
    AW --> AX
    
    AX --> AY{ğŸ“ Code Modified?}
    AY -->|Yes| AZ[ğŸ”„ Post-Execution Validation]
    AY -->|No| BA[ğŸ“¤ Final Response]
    
    AZ --> BB[ğŸ”¨ Quick Compile Check]
    BB --> BC[ğŸ§ª Critical Tests]
    BC -->|Pass| BA
    BC -->|Fail| BD[âš ï¸ Post-Execution Warning]
    BD --> BA
    
    %% Final Output
    BA --> BE[ğŸ‘¤ Enhanced Response<br/>+ Quality Insights<br/>+ Security Recommendations<br/>+ Architectural Guidance]
    T --> BF[âŒ Blocked Response<br/>+ Error Details<br/>+ Fix Suggestions]
    
    %% Styling
    classDef userAction fill:#e1f5fe
    classDef safetyCheck fill:#ffebee
    classDef qualityCheck fill:#f3e5f5
    classDef semanticFeature fill:#e8f5e8
    classDef securityFeature fill:#fff3e0
    classDef executionPhase fill:#fce4ec
    classDef blockingError fill:#ff5722,color:#fff
    classDef success fill:#4caf50,color:#fff
    
    class A,BE userAction
    class L,M,N,O,S safetyCheck
    class W,X,Y,Z qualityCheck
    class AB,AD,AE,AF,AG,AH,AI semanticFeature
    class AC,AM,AN,AO,AP securityFeature
    class AS,AT,AU,AV,AW,AX executionPhase
    class T,P,R,AR,BF blockingError
    class BA,BE success